{"ast":null,"code":"/**\n * Copyright (c) 2022\n *\n * Base classes\n *\n * @summary Base classes\n * @author Ayon Ghosh <ayon.ghosh@thoughtspot.com>\n */\nimport { getEncodedQueryParamsString, getCssDimension, getOffsetTop } from '../utils';\nimport { getThoughtSpotHost, URL_MAX_LENGTH, DEFAULT_EMBED_WIDTH, DEFAULT_EMBED_HEIGHT, getV2BasePath } from '../config';\nimport { EmbedEvent, Param } from '../types';\nimport { uploadMixpanelEvent, MIXPANEL_EVENT } from '../mixpanel-service';\nimport { getProcessData } from '../utils/processData';\nimport { processTrigger } from '../utils/processTrigger';\nimport pkgInfo from '../../package.json';\nimport { getAuthPromise, getEmbedConfig, renderInQueue } from './base';\nconst {\n  version\n} = pkgInfo;\n/**\n * The event id map from v2 event names to v1 event id\n * v1 events are the classic embed events implemented in Blink v1\n * We cannot rename v1 event types to maintain backward compatibility\n * @internal\n */\n\nconst V1EventMap = {\n  [EmbedEvent.Data]: [EmbedEvent.V1Data]\n};\n/**\n * Base class for embedding v2 experience\n * Note: the v2 version of ThoughtSpot Blink is built on the new stack:\n * React+GraphQL\n */\n\nexport class TsEmbed {\n  constructor(domSelector, viewConfig) {\n    /**\n     * Should we encode URL Query Params using base64 encoding which thoughtspot\n     * will generate for embedding. This provides additional security to\n     * thoughtspot clusters against Cross site scripting attacks.\n     * @default false\n     */\n    this.shouldEncodeUrlQueryParams = false;\n    this.el = this.getDOMNode(domSelector); // TODO: handle error\n\n    this.embedConfig = getEmbedConfig();\n    this.thoughtSpotHost = getThoughtSpotHost(this.embedConfig);\n    this.thoughtSpotV2Base = getV2BasePath(this.embedConfig);\n    this.eventHandlerMap = new Map();\n    this.isError = false;\n    this.viewConfig = viewConfig;\n    this.shouldEncodeUrlQueryParams = this.embedConfig.shouldEncodeUrlQueryParams;\n\n    if (!this.embedConfig.suppressNoCookieAccessAlert) {\n      this.on(EmbedEvent.NoCookieAccess, () => {\n        // eslint-disable-next-line no-alert\n        alert('Third party cookie access is blocked on this browser, please allow third party cookies for ThoughtSpot to work properly');\n      });\n    }\n  }\n  /**\n   * Gets a reference to the root DOM node where\n   * the embedded content will appear.\n   * @param domSelector\n   */\n\n\n  getDOMNode(domSelector) {\n    return typeof domSelector === 'string' ? document.querySelector(domSelector) : domSelector;\n  }\n  /**\n   * Throws error encountered during initialization.\n   */\n\n\n  throwInitError() {\n    this.handleError('You need to init the ThoughtSpot SDK module first');\n  }\n  /**\n   * Handles errors within the SDK\n   * @param error The error message or object\n   */\n\n\n  handleError(error) {\n    this.isError = true;\n    this.executeCallbacks(EmbedEvent.Error, {\n      error\n    }); // Log error\n\n    console.log(error);\n  }\n  /**\n   * Extracts the type field from the event payload\n   * @param event The window message event\n   */\n\n\n  getEventType(event) {\n    var _a, _b; // eslint-disable-next-line no-underscore-dangle\n\n\n    return ((_a = event.data) === null || _a === void 0 ? void 0 : _a.type) || ((_b = event.data) === null || _b === void 0 ? void 0 : _b.__type);\n  }\n  /**\n   * Extracts the port field from the event payload\n   * @param event  The window message event\n   * @returns\n   */\n\n\n  getEventPort(event) {\n    if (event.ports.length && event.ports[0]) {\n      return event.ports[0];\n    }\n\n    return null;\n  }\n  /**\n   * fix for ts7.sep.cl\n   * will be removed for ts7.oct.cl\n   * @hidden\n   */\n\n\n  formatEventData(event) {\n    const eventData = { ...event.data\n    };\n\n    if (!eventData.data) {\n      eventData.data = event.data.payload;\n    }\n\n    return eventData;\n  }\n  /**\n   * Adds a global event listener to window for \"message\" events.\n   * ThoughtSpot detects if a particular event is targeted to this\n   * embed instance through an identifier contained in the payload,\n   * and executes the registered callbacks accordingly.\n   */\n\n\n  subscribeToEvents() {\n    window.addEventListener('message', event => {\n      const eventType = this.getEventType(event);\n      const eventPort = this.getEventPort(event);\n      const eventData = this.formatEventData(event);\n\n      if (event.source === this.iFrame.contentWindow) {\n        this.executeCallbacks(eventType, getProcessData(eventType, eventData, this.thoughtSpotHost), eventPort);\n      }\n    });\n  }\n  /**\n   * Constructs the base URL string to load the ThoughtSpot app.\n   */\n\n\n  getEmbedBasePath(query) {\n    let queryString = query;\n\n    if (this.shouldEncodeUrlQueryParams) {\n      queryString = `?base64UrlEncodedFlags=${getEncodedQueryParamsString(queryString.substr(1))}`;\n    }\n\n    const basePath = [this.thoughtSpotHost, this.thoughtSpotV2Base, queryString].filter(x => x.length > 0).join('/');\n    return `${basePath}#/embed`;\n  }\n  /**\n   * Common query params set for all the embed modes.\n   * @returns queryParams\n   */\n\n\n  getBaseQueryParams() {\n    var _a;\n\n    const queryParams = {};\n    let hostAppUrl = ((_a = window === null || window === void 0 ? void 0 : window.location) === null || _a === void 0 ? void 0 : _a.host) || ''; // The below check is needed because TS Cloud firewall, blocks localhost/127.0.0.1\n    // in any url param.\n\n    if (hostAppUrl.includes('localhost') || hostAppUrl.includes('127.0.0.1')) {\n      hostAppUrl = 'local-host';\n    }\n\n    queryParams[Param.HostAppUrl] = encodeURIComponent(hostAppUrl);\n    queryParams[Param.ViewPortHeight] = window.innerHeight;\n    queryParams[Param.ViewPortWidth] = window.innerWidth;\n    queryParams[Param.Version] = version;\n\n    if (this.embedConfig.disableLoginRedirect === true || this.embedConfig.autoLogin === true) {\n      queryParams[Param.DisableLoginRedirect] = true;\n    }\n\n    if (this.embedConfig.customCssUrl) {\n      queryParams[Param.CustomCSSUrl] = this.embedConfig.customCssUrl;\n    }\n\n    const {\n      disabledActions,\n      disabledActionReason,\n      hiddenActions,\n      visibleActions,\n      additionalFlags,\n      locale\n    } = this.viewConfig;\n\n    if (Array.isArray(visibleActions) && Array.isArray(hiddenActions)) {\n      this.handleError('You cannot have both hidden actions and visible actions');\n      return queryParams;\n    }\n\n    if (disabledActions === null || disabledActions === void 0 ? void 0 : disabledActions.length) {\n      queryParams[Param.DisableActions] = disabledActions;\n    }\n\n    if (disabledActionReason) {\n      queryParams[Param.DisableActionReason] = disabledActionReason;\n    }\n\n    if (hiddenActions === null || hiddenActions === void 0 ? void 0 : hiddenActions.length) {\n      queryParams[Param.HideActions] = hiddenActions;\n    }\n\n    if (Array.isArray(visibleActions)) {\n      queryParams[Param.VisibleActions] = visibleActions;\n    }\n\n    if (locale !== undefined) {\n      queryParams[Param.Locale] = locale;\n    }\n\n    if (additionalFlags && additionalFlags.constructor.name === 'Object') {\n      Object.assign(queryParams, additionalFlags);\n    }\n\n    return queryParams;\n  }\n  /**\n   * Constructs the base URL string to load v1 of the ThoughtSpot app.\n   * This is used for embedding Liveboards, visualizations, and full application.\n   * @param queryString The query string to append to the URL.\n   * @param isAppEmbed A Boolean parameter to specify if you are embedding\n   * the full application.\n   */\n\n\n  getV1EmbedBasePath(queryString) {\n    let showPrimaryNavbar = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : false;\n    let disableProfileAndHelp = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : false;\n    let isAppEmbed = arguments.length > 3 && arguments[3] !== undefined ? arguments[3] : false;\n    const queryStringFrag = queryString ? `&${queryString}` : '';\n    const primaryNavParam = `&primaryNavHidden=${!showPrimaryNavbar}`;\n    const disableProfileAndHelpParam = `&profileAndHelpInNavBarHidden=${disableProfileAndHelp}`;\n    let queryParams = `?embedApp=true${isAppEmbed ? primaryNavParam : ''}${isAppEmbed ? disableProfileAndHelpParam : ''}${queryStringFrag}`;\n\n    if (this.shouldEncodeUrlQueryParams) {\n      queryParams = `?base64UrlEncodedFlags=${getEncodedQueryParamsString(queryParams.substr(1))}`;\n    }\n\n    let path = `${this.thoughtSpotHost}/${queryParams}#`;\n\n    if (!isAppEmbed) {\n      path = `${path}/embed`;\n    }\n\n    return path;\n  }\n  /**\n   * Renders the embedded ThoughtSpot app in an iframe and sets up\n   * event listeners.\n   * @param url\n   * @param frameOptions\n   */\n\n\n  renderIFrame(url, frameOptions) {\n    if (this.isError) {\n      return;\n    }\n\n    if (!this.thoughtSpotHost) {\n      this.throwInitError();\n    }\n\n    if (url.length > URL_MAX_LENGTH) {// warn: The URL is too long\n    }\n\n    renderInQueue(nextInQueue => {\n      var _a;\n\n      const initTimestamp = Date.now();\n      this.executeCallbacks(EmbedEvent.Init, {\n        data: {\n          timestamp: initTimestamp\n        }\n      });\n      uploadMixpanelEvent(MIXPANEL_EVENT.VISUAL_SDK_RENDER_START);\n      (_a = getAuthPromise()) === null || _a === void 0 ? void 0 : _a.then(() => {\n        uploadMixpanelEvent(MIXPANEL_EVENT.VISUAL_SDK_RENDER_COMPLETE);\n        this.iFrame = this.iFrame || document.createElement('iframe');\n        this.iFrame.src = url; // according to screenfull.js documentation\n        // allowFullscreen, webkitallowfullscreen and mozallowfullscreen must be true\n\n        this.iFrame.allowFullscreen = true; // eslint-disable-next-line @typescript-eslint/ban-ts-comment\n        // @ts-ignore\n\n        this.iFrame.webkitallowfullscreen = true; // eslint-disable-next-line @typescript-eslint/ban-ts-comment\n        // @ts-ignore\n\n        this.iFrame.mozallowfullscreen = true;\n        const width = getCssDimension((frameOptions === null || frameOptions === void 0 ? void 0 : frameOptions.width) || DEFAULT_EMBED_WIDTH);\n        const height = getCssDimension((frameOptions === null || frameOptions === void 0 ? void 0 : frameOptions.height) || DEFAULT_EMBED_HEIGHT);\n        this.iFrame.style.width = `${width}`;\n        this.iFrame.style.height = `${height}`;\n        this.iFrame.style.border = '0';\n        this.iFrame.name = 'ThoughtSpot Embedded Analytics';\n        this.iFrame.addEventListener('load', () => {\n          nextInQueue();\n          const loadTimestamp = Date.now();\n          this.executeCallbacks(EmbedEvent.Load, {\n            data: {\n              timestamp: loadTimestamp\n            }\n          });\n          uploadMixpanelEvent(MIXPANEL_EVENT.VISUAL_SDK_IFRAME_LOAD_PERFORMANCE, {\n            timeTookToLoad: loadTimestamp - initTimestamp\n          });\n        });\n        this.iFrame.addEventListener('error', () => {\n          nextInQueue();\n        });\n        this.el.innerHTML = '';\n        this.el.appendChild(this.iFrame);\n        const prefetchIframe = document.querySelectorAll('.prefetchIframe');\n\n        if (prefetchIframe.length) {\n          prefetchIframe.forEach(el => {\n            el.remove();\n          });\n        }\n\n        this.subscribeToEvents();\n      }).catch(error => {\n        nextInQueue();\n        uploadMixpanelEvent(MIXPANEL_EVENT.VISUAL_SDK_RENDER_FAILED);\n        this.handleError(error);\n      });\n    });\n  }\n  /**\n   * Sets the height of the iframe\n   * @param height The height in pixels\n   */\n\n\n  setIFrameHeight(height) {\n    this.iFrame.style.height = `${height}px`;\n  }\n  /**\n   * Executes all registered event handlers for a particular event type\n   * @param eventType The event type\n   * @param data The payload invoked with the event handler\n   * @param eventPort The event Port for a specific MessageChannel\n   */\n\n\n  executeCallbacks(eventType, data, eventPort) {\n    const callbacks = this.eventHandlerMap.get(eventType) || [];\n    callbacks.forEach(callback => callback(data, payload => {\n      this.triggerEventOnPort(eventPort, payload);\n    }));\n  }\n  /**\n   * Returns the ThoughtSpot hostname or IP address.\n   */\n\n\n  getThoughtSpotHost() {\n    return this.thoughtSpotHost;\n  }\n  /**\n   * Gets the v1 event type (if applicable) for the EmbedEvent type\n   * @param eventType The v2 event type\n   * @returns The corresponding v1 event type if one exists\n   * or else the v2 event type itself\n   */\n\n\n  getCompatibleEventType(eventType) {\n    return V1EventMap[eventType] || eventType;\n  }\n  /**\n   * Calculates the iframe center for the current visible viewPort\n   * of iframe using Scroll position of Host App, offsetTop for iframe\n   * in Host app. ViewPort height of the tab.\n   * @returns iframe Center in visible viewport,\n   *  Iframe height,\n   *  View port height.\n   */\n\n\n  getIframeCenter() {\n    const offsetTopClient = getOffsetTop(this.iFrame);\n    const scrollTopClient = window.scrollY;\n    const viewPortHeight = window.innerHeight;\n    const iframeHeight = this.iFrame.offsetHeight;\n    const iframeScrolled = scrollTopClient - offsetTopClient;\n    let iframeVisibleViewPort;\n    let iframeOffset;\n\n    if (iframeScrolled < 0) {\n      iframeVisibleViewPort = viewPortHeight - (offsetTopClient - scrollTopClient);\n      iframeVisibleViewPort = Math.min(iframeHeight, iframeVisibleViewPort);\n      iframeOffset = 0;\n    } else {\n      iframeVisibleViewPort = Math.min(iframeHeight - iframeScrolled, viewPortHeight);\n      iframeOffset = iframeScrolled;\n    }\n\n    const iframeCenter = iframeOffset + iframeVisibleViewPort / 2;\n    return {\n      iframeCenter,\n      iframeScrolled,\n      iframeHeight,\n      viewPortHeight,\n      iframeVisibleViewPort\n    };\n  }\n  /**\n   * Registers an event listener to trigger an alert when the ThoughtSpot app\n   * sends an event of a particular message type to the host application.\n   *\n   * @param messageType The message type\n   * @param callback A callback function\n   */\n\n\n  on(messageType, callback) {\n    if (this.isRendered) {\n      this.handleError('Please register event handlers before calling render');\n    }\n\n    const callbacks = this.eventHandlerMap.get(messageType) || [];\n    callbacks.push(callback);\n    this.eventHandlerMap.set(messageType, callbacks);\n    return this;\n  }\n  /**\n   * Triggers an event on specific Port registered against\n   * for the EmbedEvent\n   * @param eventType The message type\n   * @param data The payload to send\n   */\n\n\n  triggerEventOnPort(eventPort, payload) {\n    if (eventPort) {\n      try {\n        eventPort.postMessage({\n          type: payload.type,\n          data: payload.data\n        });\n      } catch (e) {\n        eventPort.postMessage({\n          error: e\n        });\n        console.log(e);\n      }\n    } else {\n      console.log('Event Port is not defined');\n    }\n  }\n  /**\n   * Triggers an event to the embedded app\n   * @param messageType The event type\n   * @param data The payload to send with the message\n   */\n\n\n  trigger(messageType, data) {\n    processTrigger(this.iFrame, messageType, this.thoughtSpotHost, data);\n    uploadMixpanelEvent(`${MIXPANEL_EVENT.VISUAL_SDK_TRIGGER}-${messageType}`);\n    return this;\n  }\n  /**\n   * Marks the ThoughtSpot object to have been rendered\n   * Needs to be overridden by subclasses to do the actual\n   * rendering of the iframe.\n   * @param args\n   */\n\n\n  render() {\n    this.isRendered = true;\n    return this;\n  }\n\n}\n/**\n * Base class for embedding v1 experience\n * Note: The v1 version of ThoughtSpot Blink works on the AngularJS stack\n * which is currently under migration to v2\n */\n\nexport class V1Embed extends TsEmbed {\n  constructor(domSelector, viewConfig) {\n    super(domSelector, viewConfig);\n    this.viewConfig = viewConfig;\n  }\n  /**\n   * Render the app in an iframe and set up event handlers\n   * @param iframeSrc\n   */\n\n\n  renderV1Embed(iframeSrc) {\n    this.renderIFrame(iframeSrc, this.viewConfig.frameParams);\n  } // @override\n\n\n  on(messageType, callback) {\n    const eventType = this.getCompatibleEventType(messageType);\n    return super.on(eventType, callback);\n  }\n\n}","map":{"version":3,"mappings":"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","names":["getEncodedQueryParamsString","getCssDimension","getOffsetTop","getThoughtSpotHost","URL_MAX_LENGTH","DEFAULT_EMBED_WIDTH","DEFAULT_EMBED_HEIGHT","getV2BasePath","EmbedEvent","Param","uploadMixpanelEvent","MIXPANEL_EVENT","getProcessData","processTrigger","pkgInfo","getAuthPromise","getEmbedConfig","renderInQueue","version","V1EventMap","Data","V1Data","TsEmbed","constructor","domSelector","viewConfig","el","getDOMNode","embedConfig","thoughtSpotHost","thoughtSpotV2Base","eventHandlerMap","Map","isError","shouldEncodeUrlQueryParams","suppressNoCookieAccessAlert","on","NoCookieAccess","alert","document","querySelector","throwInitError","handleError","error","executeCallbacks","Error","console","log","getEventType","event","data","_a","type","_b","__type","getEventPort","ports","length","formatEventData","eventData","payload","subscribeToEvents","window","addEventListener","eventType","eventPort","source","iFrame","contentWindow","getEmbedBasePath","query","queryString","substr","basePath","filter","x","join","getBaseQueryParams","queryParams","hostAppUrl","location","host","includes","HostAppUrl","encodeURIComponent","ViewPortHeight","innerHeight","ViewPortWidth","innerWidth","Version","disableLoginRedirect","autoLogin","DisableLoginRedirect","customCssUrl","CustomCSSUrl","disabledActions","disabledActionReason","hiddenActions","visibleActions","additionalFlags","locale","Array","isArray","DisableActions","DisableActionReason","HideActions","VisibleActions","undefined","Locale","name","Object","assign","getV1EmbedBasePath","showPrimaryNavbar","disableProfileAndHelp","isAppEmbed","queryStringFrag","primaryNavParam","disableProfileAndHelpParam","path","renderIFrame","url","frameOptions","nextInQueue","initTimestamp","Date","now","Init","timestamp","VISUAL_SDK_RENDER_START","then","VISUAL_SDK_RENDER_COMPLETE","createElement","src","allowFullscreen","webkitallowfullscreen","mozallowfullscreen","width","height","style","border","loadTimestamp","Load","VISUAL_SDK_IFRAME_LOAD_PERFORMANCE","timeTookToLoad","innerHTML","appendChild","prefetchIframe","querySelectorAll","forEach","remove","catch","VISUAL_SDK_RENDER_FAILED","setIFrameHeight","callbacks","get","callback","triggerEventOnPort","getCompatibleEventType","getIframeCenter","offsetTopClient","scrollTopClient","scrollY","viewPortHeight","iframeHeight","offsetHeight","iframeScrolled","iframeVisibleViewPort","iframeOffset","Math","min","iframeCenter","messageType","isRendered","push","set","postMessage","e","trigger","VISUAL_SDK_TRIGGER","render","V1Embed","renderV1Embed","iframeSrc","frameParams"],"sources":["/Users/nathan.schroeder/Documents/dev/ts-integration-demo/node_modules/@thoughtspot/visual-embed-sdk/src/embed/ts-embed.ts"],"sourcesContent":["/**\n * Copyright (c) 2022\n *\n * Base classes\n *\n * @summary Base classes\n * @author Ayon Ghosh <ayon.ghosh@thoughtspot.com>\n */\n\nimport {\n    getEncodedQueryParamsString,\n    getCssDimension,\n    getOffsetTop,\n} from '../utils';\nimport {\n    getThoughtSpotHost,\n    URL_MAX_LENGTH,\n    DEFAULT_EMBED_WIDTH,\n    DEFAULT_EMBED_HEIGHT,\n    getV2BasePath,\n} from '../config';\nimport {\n    DOMSelector,\n    HostEvent,\n    EmbedEvent,\n    MessageCallback,\n    Action,\n    RuntimeFilter,\n    Param,\n    EmbedConfig,\n} from '../types';\nimport { uploadMixpanelEvent, MIXPANEL_EVENT } from '../mixpanel-service';\nimport { getProcessData } from '../utils/processData';\nimport { processTrigger } from '../utils/processTrigger';\nimport pkgInfo from '../../package.json';\nimport { getAuthPromise, getEmbedConfig, renderInQueue } from './base';\n\nconst { version } = pkgInfo;\n\n/**\n * The event id map from v2 event names to v1 event id\n * v1 events are the classic embed events implemented in Blink v1\n * We cannot rename v1 event types to maintain backward compatibility\n * @internal\n */\nconst V1EventMap = {\n    [EmbedEvent.Data]: [EmbedEvent.V1Data],\n};\n\n// eslint-disable-next-line @typescript-eslint/no-empty-interface\nexport interface LayoutConfig {}\n\n/**\n * Embedded iFrame configuration\n */\nexport interface FrameParams {\n    /**\n     * The width of the iFrame (unit is pixels if numeric).\n     */\n    width?: number | string;\n    /**\n     * The height of the iFrame (unit is pixels if numeric).\n     */\n    height?: number | string;\n}\n\n/**\n * The configuration object for an embedded view.\n */\nexport interface ViewConfig {\n    /**\n     * @hidden\n     */\n    layoutConfig?: LayoutConfig;\n    /**\n     * The <b>width</b> and <b>height</b> dimensions to render an embedded object inside your app.  Specify the values in pixels or percentage.\n     */\n    frameParams?: FrameParams;\n    /**\n     * @hidden\n     */\n    theme?: string;\n    /**\n     * @hidden\n     */\n    // eslint-disable-next-line camelcase\n    styleSheet__unstable?: string;\n    /**\n     * The list of actions to disable from the primary menu, more menu\n     * (...), and the contextual menu.\n     */\n    disabledActions?: Action[];\n    /**\n     * The tooltip to display for disabled actions.\n     */\n    disabledActionReason?: string;\n    /**\n     * The list of actions to hide from the primary menu, more menu\n     * (...), and the contextual menu.\n     */\n    hiddenActions?: Action[];\n    /**\n     * The list of actions to display from the primary menu, more menu\n     * (...), and the contextual menu.\n     * @version 1.6.0 or later\n     */\n    visibleActions?: Action[];\n    /**\n     * The list of runtime filters to apply to a search answer,\n     * visualization, or Liveboard.\n     */\n    runtimeFilters?: RuntimeFilter[];\n    /**\n     * The locale/language to use for the embedded view.\n     * @version 1.9.5 or later\n     */\n    locale?: string;\n    /**\n     * This is an object (key/val) of override flags which will be applied\n     * to the internal embedded object. This can be used to add any\n     * URL flag.\n     * @version SDK: 1.9.0 | ThoughtSpot: 8.1.0.cl\n     */\n    additionalFlags?: { [key: string]: string | number | boolean };\n}\n\n/**\n * Base class for embedding v2 experience\n * Note: the v2 version of ThoughtSpot Blink is built on the new stack:\n * React+GraphQL\n */\nexport class TsEmbed {\n    /**\n     * The DOM node where the ThoughtSpot app is to be embedded.\n     */\n    private el: Element;\n\n    /**\n     * A reference to the iframe within which the ThoughtSpot app\n     * will be rendered.\n     */\n    protected iFrame: HTMLIFrameElement;\n\n    protected viewConfig: ViewConfig;\n\n    protected embedConfig: EmbedConfig;\n\n    /**\n     * The ThoughtSpot hostname or IP address\n     */\n    protected thoughtSpotHost: string;\n\n    /*\n     * This is the base to access ThoughtSpot V2.\n     */\n    protected thoughtSpotV2Base: string;\n\n    /**\n     * A map of event handlers for particular message types triggered\n     * by the embedded app; multiple event handlers can be registered\n     * against a particular message type.\n     */\n    private eventHandlerMap: Map<string, MessageCallback[]>;\n\n    /**\n     * A flag that is set to true post render.\n     */\n    private isRendered: boolean;\n\n    /**\n     * A flag to mark if an error has occurred.\n     */\n    private isError: boolean;\n\n    /**\n     * Should we encode URL Query Params using base64 encoding which thoughtspot\n     * will generate for embedding. This provides additional security to\n     * thoughtspot clusters against Cross site scripting attacks.\n     * @default false\n     */\n    private shouldEncodeUrlQueryParams = false;\n\n    constructor(domSelector: DOMSelector, viewConfig?: ViewConfig) {\n        this.el = this.getDOMNode(domSelector);\n        // TODO: handle error\n        this.embedConfig = getEmbedConfig();\n        this.thoughtSpotHost = getThoughtSpotHost(this.embedConfig);\n        this.thoughtSpotV2Base = getV2BasePath(this.embedConfig);\n        this.eventHandlerMap = new Map();\n        this.isError = false;\n        this.viewConfig = viewConfig;\n        this.shouldEncodeUrlQueryParams = this.embedConfig.shouldEncodeUrlQueryParams;\n        if (!this.embedConfig.suppressNoCookieAccessAlert) {\n            this.on(EmbedEvent.NoCookieAccess, () => {\n                // eslint-disable-next-line no-alert\n                alert(\n                    'Third party cookie access is blocked on this browser, please allow third party cookies for ThoughtSpot to work properly',\n                );\n            });\n        }\n    }\n\n    /**\n     * Gets a reference to the root DOM node where\n     * the embedded content will appear.\n     * @param domSelector\n     */\n    private getDOMNode(domSelector: DOMSelector) {\n        return typeof domSelector === 'string'\n            ? document.querySelector(domSelector)\n            : domSelector;\n    }\n\n    /**\n     * Throws error encountered during initialization.\n     */\n    private throwInitError() {\n        this.handleError('You need to init the ThoughtSpot SDK module first');\n    }\n\n    /**\n     * Handles errors within the SDK\n     * @param error The error message or object\n     */\n    protected handleError(error: string | Record<string, unknown>) {\n        this.isError = true;\n        this.executeCallbacks(EmbedEvent.Error, {\n            error,\n        });\n        // Log error\n        console.log(error);\n    }\n\n    /**\n     * Extracts the type field from the event payload\n     * @param event The window message event\n     */\n    private getEventType(event: MessageEvent) {\n        // eslint-disable-next-line no-underscore-dangle\n        return event.data?.type || event.data?.__type;\n    }\n\n    /**\n     * Extracts the port field from the event payload\n     * @param event  The window message event\n     * @returns\n     */\n    private getEventPort(event: MessageEvent) {\n        if (event.ports.length && event.ports[0]) {\n            return event.ports[0];\n        }\n        return null;\n    }\n\n    /**\n     * fix for ts7.sep.cl\n     * will be removed for ts7.oct.cl\n     * @hidden\n     */\n    private formatEventData(event: MessageEvent) {\n        const eventData = {\n            ...event.data,\n        };\n        if (!eventData.data) {\n            eventData.data = event.data.payload;\n        }\n        return eventData;\n    }\n\n    /**\n     * Adds a global event listener to window for \"message\" events.\n     * ThoughtSpot detects if a particular event is targeted to this\n     * embed instance through an identifier contained in the payload,\n     * and executes the registered callbacks accordingly.\n     */\n    private subscribeToEvents() {\n        window.addEventListener('message', (event) => {\n            const eventType = this.getEventType(event);\n            const eventPort = this.getEventPort(event);\n            const eventData = this.formatEventData(event);\n            if (event.source === this.iFrame.contentWindow) {\n                this.executeCallbacks(\n                    eventType,\n                    getProcessData(eventType, eventData, this.thoughtSpotHost),\n                    eventPort,\n                );\n            }\n        });\n    }\n\n    /**\n     * Constructs the base URL string to load the ThoughtSpot app.\n     */\n    protected getEmbedBasePath(query: string): string {\n        let queryString = query;\n        if (this.shouldEncodeUrlQueryParams) {\n            queryString = `?base64UrlEncodedFlags=${getEncodedQueryParamsString(\n                queryString.substr(1),\n            )}`;\n        }\n        const basePath = [\n            this.thoughtSpotHost,\n            this.thoughtSpotV2Base,\n            queryString,\n        ]\n            .filter((x) => x.length > 0)\n            .join('/');\n\n        return `${basePath}#/embed`;\n    }\n\n    /**\n     * Common query params set for all the embed modes.\n     * @returns queryParams\n     */\n    protected getBaseQueryParams() {\n        const queryParams = {};\n        let hostAppUrl = window?.location?.host || '';\n\n        // The below check is needed because TS Cloud firewall, blocks localhost/127.0.0.1\n        // in any url param.\n        if (\n            hostAppUrl.includes('localhost') ||\n            hostAppUrl.includes('127.0.0.1')\n        ) {\n            hostAppUrl = 'local-host';\n        }\n        queryParams[Param.HostAppUrl] = encodeURIComponent(hostAppUrl);\n        queryParams[Param.ViewPortHeight] = window.innerHeight;\n        queryParams[Param.ViewPortWidth] = window.innerWidth;\n        queryParams[Param.Version] = version;\n        if (\n            this.embedConfig.disableLoginRedirect === true ||\n            this.embedConfig.autoLogin === true\n        ) {\n            queryParams[Param.DisableLoginRedirect] = true;\n        }\n        if (this.embedConfig.customCssUrl) {\n            queryParams[Param.CustomCSSUrl] = this.embedConfig.customCssUrl;\n        }\n\n        const {\n            disabledActions,\n            disabledActionReason,\n            hiddenActions,\n            visibleActions,\n            additionalFlags,\n            locale,\n        } = this.viewConfig;\n\n        if (Array.isArray(visibleActions) && Array.isArray(hiddenActions)) {\n            this.handleError(\n                'You cannot have both hidden actions and visible actions',\n            );\n            return queryParams;\n        }\n\n        if (disabledActions?.length) {\n            queryParams[Param.DisableActions] = disabledActions;\n        }\n        if (disabledActionReason) {\n            queryParams[Param.DisableActionReason] = disabledActionReason;\n        }\n        if (hiddenActions?.length) {\n            queryParams[Param.HideActions] = hiddenActions;\n        }\n        if (Array.isArray(visibleActions)) {\n            queryParams[Param.VisibleActions] = visibleActions;\n        }\n        if (locale !== undefined) {\n            queryParams[Param.Locale] = locale;\n        }\n        if (additionalFlags && additionalFlags.constructor.name === 'Object') {\n            Object.assign(queryParams, additionalFlags);\n        }\n        return queryParams;\n    }\n\n    /**\n     * Constructs the base URL string to load v1 of the ThoughtSpot app.\n     * This is used for embedding Liveboards, visualizations, and full application.\n     * @param queryString The query string to append to the URL.\n     * @param isAppEmbed A Boolean parameter to specify if you are embedding\n     * the full application.\n     */\n    protected getV1EmbedBasePath(\n        queryString: string,\n        showPrimaryNavbar = false,\n        disableProfileAndHelp = false,\n        isAppEmbed = false,\n    ): string {\n        const queryStringFrag = queryString ? `&${queryString}` : '';\n        const primaryNavParam = `&primaryNavHidden=${!showPrimaryNavbar}`;\n        const disableProfileAndHelpParam = `&profileAndHelpInNavBarHidden=${disableProfileAndHelp}`;\n        let queryParams = `?embedApp=true${isAppEmbed ? primaryNavParam : ''}${\n            isAppEmbed ? disableProfileAndHelpParam : ''\n        }${queryStringFrag}`;\n        if (this.shouldEncodeUrlQueryParams) {\n            queryParams = `?base64UrlEncodedFlags=${getEncodedQueryParamsString(\n                queryParams.substr(1),\n            )}`;\n        }\n        let path = `${this.thoughtSpotHost}/${queryParams}#`;\n        if (!isAppEmbed) {\n            path = `${path}/embed`;\n        }\n        return path;\n    }\n\n    /**\n     * Renders the embedded ThoughtSpot app in an iframe and sets up\n     * event listeners.\n     * @param url\n     * @param frameOptions\n     */\n    protected renderIFrame(url: string, frameOptions: FrameParams): void {\n        if (this.isError) {\n            return;\n        }\n        if (!this.thoughtSpotHost) {\n            this.throwInitError();\n        }\n        if (url.length > URL_MAX_LENGTH) {\n            // warn: The URL is too long\n        }\n\n        renderInQueue((nextInQueue) => {\n            const initTimestamp = Date.now();\n\n            this.executeCallbacks(EmbedEvent.Init, {\n                data: {\n                    timestamp: initTimestamp,\n                },\n            });\n\n            uploadMixpanelEvent(MIXPANEL_EVENT.VISUAL_SDK_RENDER_START);\n\n            getAuthPromise()\n                ?.then(() => {\n                    uploadMixpanelEvent(\n                        MIXPANEL_EVENT.VISUAL_SDK_RENDER_COMPLETE,\n                    );\n\n                    this.iFrame =\n                        this.iFrame || document.createElement('iframe');\n\n                    this.iFrame.src = url;\n\n                    // according to screenfull.js documentation\n                    // allowFullscreen, webkitallowfullscreen and mozallowfullscreen must be true\n                    this.iFrame.allowFullscreen = true;\n                    // eslint-disable-next-line @typescript-eslint/ban-ts-comment\n                    // @ts-ignore\n                    this.iFrame.webkitallowfullscreen = true;\n                    // eslint-disable-next-line @typescript-eslint/ban-ts-comment\n                    // @ts-ignore\n                    this.iFrame.mozallowfullscreen = true;\n                    const width = getCssDimension(\n                        frameOptions?.width || DEFAULT_EMBED_WIDTH,\n                    );\n                    const height = getCssDimension(\n                        frameOptions?.height || DEFAULT_EMBED_HEIGHT,\n                    );\n                    this.iFrame.style.width = `${width}`;\n                    this.iFrame.style.height = `${height}`;\n                    this.iFrame.style.border = '0';\n                    this.iFrame.name = 'ThoughtSpot Embedded Analytics';\n                    this.iFrame.addEventListener('load', () => {\n                        nextInQueue();\n                        const loadTimestamp = Date.now();\n                        this.executeCallbacks(EmbedEvent.Load, {\n                            data: {\n                                timestamp: loadTimestamp,\n                            },\n                        });\n                        uploadMixpanelEvent(\n                            MIXPANEL_EVENT.VISUAL_SDK_IFRAME_LOAD_PERFORMANCE,\n                            {\n                                timeTookToLoad: loadTimestamp - initTimestamp,\n                            },\n                        );\n                    });\n                    this.iFrame.addEventListener('error', () => {\n                        nextInQueue();\n                    });\n                    this.el.innerHTML = '';\n                    this.el.appendChild(this.iFrame);\n                    const prefetchIframe = document.querySelectorAll(\n                        '.prefetchIframe',\n                    );\n                    if (prefetchIframe.length) {\n                        prefetchIframe.forEach((el) => {\n                            el.remove();\n                        });\n                    }\n                    this.subscribeToEvents();\n                })\n                .catch((error) => {\n                    nextInQueue();\n                    uploadMixpanelEvent(\n                        MIXPANEL_EVENT.VISUAL_SDK_RENDER_FAILED,\n                    );\n                    this.handleError(error);\n                });\n        });\n    }\n\n    /**\n     * Sets the height of the iframe\n     * @param height The height in pixels\n     */\n    protected setIFrameHeight(height: number): void {\n        this.iFrame.style.height = `${height}px`;\n    }\n\n    /**\n     * Executes all registered event handlers for a particular event type\n     * @param eventType The event type\n     * @param data The payload invoked with the event handler\n     * @param eventPort The event Port for a specific MessageChannel\n     */\n    protected executeCallbacks(\n        eventType: EmbedEvent,\n        data: any,\n        eventPort?: MessagePort | void,\n    ): void {\n        const callbacks = this.eventHandlerMap.get(eventType) || [];\n        callbacks.forEach((callback) =>\n            callback(data, (payload) => {\n                this.triggerEventOnPort(eventPort, payload);\n            }),\n        );\n    }\n\n    /**\n     * Returns the ThoughtSpot hostname or IP address.\n     */\n    protected getThoughtSpotHost(): string {\n        return this.thoughtSpotHost;\n    }\n\n    /**\n     * Gets the v1 event type (if applicable) for the EmbedEvent type\n     * @param eventType The v2 event type\n     * @returns The corresponding v1 event type if one exists\n     * or else the v2 event type itself\n     */\n    protected getCompatibleEventType(eventType: EmbedEvent): EmbedEvent {\n        return V1EventMap[eventType] || eventType;\n    }\n\n    /**\n     * Calculates the iframe center for the current visible viewPort\n     * of iframe using Scroll position of Host App, offsetTop for iframe\n     * in Host app. ViewPort height of the tab.\n     * @returns iframe Center in visible viewport,\n     *  Iframe height,\n     *  View port height.\n     */\n    protected getIframeCenter() {\n        const offsetTopClient = getOffsetTop(this.iFrame);\n        const scrollTopClient = window.scrollY;\n        const viewPortHeight = window.innerHeight;\n        const iframeHeight = this.iFrame.offsetHeight;\n        const iframeScrolled = scrollTopClient - offsetTopClient;\n        let iframeVisibleViewPort;\n        let iframeOffset;\n\n        if (iframeScrolled < 0) {\n            iframeVisibleViewPort =\n                viewPortHeight - (offsetTopClient - scrollTopClient);\n            iframeVisibleViewPort = Math.min(\n                iframeHeight,\n                iframeVisibleViewPort,\n            );\n            iframeOffset = 0;\n        } else {\n            iframeVisibleViewPort = Math.min(\n                iframeHeight - iframeScrolled,\n                viewPortHeight,\n            );\n            iframeOffset = iframeScrolled;\n        }\n        const iframeCenter = iframeOffset + iframeVisibleViewPort / 2;\n        return {\n            iframeCenter,\n            iframeScrolled,\n            iframeHeight,\n            viewPortHeight,\n            iframeVisibleViewPort,\n        };\n    }\n\n    /**\n     * Registers an event listener to trigger an alert when the ThoughtSpot app\n     * sends an event of a particular message type to the host application.\n     *\n     * @param messageType The message type\n     * @param callback A callback function\n     */\n    public on(\n        messageType: EmbedEvent,\n        callback: MessageCallback,\n    ): typeof TsEmbed.prototype {\n        if (this.isRendered) {\n            this.handleError(\n                'Please register event handlers before calling render',\n            );\n        }\n\n        const callbacks = this.eventHandlerMap.get(messageType) || [];\n        callbacks.push(callback);\n        this.eventHandlerMap.set(messageType, callbacks);\n        return this;\n    }\n\n    /**\n     * Triggers an event on specific Port registered against\n     * for the EmbedEvent\n     * @param eventType The message type\n     * @param data The payload to send\n     */\n    private triggerEventOnPort(eventPort: MessagePort | void, payload: any) {\n        if (eventPort) {\n            try {\n                eventPort.postMessage({\n                    type: payload.type,\n                    data: payload.data,\n                });\n            } catch (e) {\n                eventPort.postMessage({ error: e });\n                console.log(e);\n            }\n        } else {\n            console.log('Event Port is not defined');\n        }\n    }\n\n    /**\n     * Triggers an event to the embedded app\n     * @param messageType The event type\n     * @param data The payload to send with the message\n     */\n    public trigger(\n        messageType: HostEvent,\n        data: any,\n    ): typeof TsEmbed.prototype {\n        processTrigger(this.iFrame, messageType, this.thoughtSpotHost, data);\n        uploadMixpanelEvent(\n            `${MIXPANEL_EVENT.VISUAL_SDK_TRIGGER}-${messageType}`,\n        );\n        return this;\n    }\n\n    /**\n     * Marks the ThoughtSpot object to have been rendered\n     * Needs to be overridden by subclasses to do the actual\n     * rendering of the iframe.\n     * @param args\n     */\n    public render(): TsEmbed {\n        this.isRendered = true;\n\n        return this;\n    }\n}\n\n/**\n * Base class for embedding v1 experience\n * Note: The v1 version of ThoughtSpot Blink works on the AngularJS stack\n * which is currently under migration to v2\n */\nexport class V1Embed extends TsEmbed {\n    protected viewConfig: ViewConfig;\n\n    constructor(domSelector: DOMSelector, viewConfig: ViewConfig) {\n        super(domSelector, viewConfig);\n        this.viewConfig = viewConfig;\n    }\n\n    /**\n     * Render the app in an iframe and set up event handlers\n     * @param iframeSrc\n     */\n    protected renderV1Embed(iframeSrc: string): void {\n        this.renderIFrame(iframeSrc, this.viewConfig.frameParams);\n    }\n\n    // @override\n    public on(\n        messageType: EmbedEvent,\n        callback: MessageCallback,\n    ): typeof TsEmbed.prototype {\n        const eventType = this.getCompatibleEventType(messageType);\n\n        return super.on(eventType, callback);\n    }\n}\n"]},"metadata":{},"sourceType":"module"}